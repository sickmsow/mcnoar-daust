<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MCNOAR — Oldest Human Skull AR</title>
    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <!-- MindAR -->
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    <!-- Gesture Detector for interactions -->
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.0.0/dist/aframe-extras.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: system-ui, sans-serif;
        background: #000;
        overflow: hidden;
      }
      .ui {
        position: fixed;
        top: 12px;
        left: 12px;
        right: 12px;
        display: flex;
        justify-content: space-between;
        gap: 12px;
        z-index: 50;
        pointer-events: none;
      }
      .ui .card {
        pointer-events: auto;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(10px);
        padding: 10px 16px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        font-size: 13px;
        color: #fff;
      }
      .center-hint {
        position: fixed;
        bottom: 200px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 50;
        pointer-events: none;
        background: rgba(255, 255, 255, 0.95);
        color: #222;
        padding: 10px 20px;
        border-radius: 999px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2);
        font-size: 14px;
        text-align: center;
        transition: opacity 0.3s;
      }
      .mode-toggle {
        position: fixed;
        bottom: 140px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 50;
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        border: none;
        padding: 14px 32px;
        border-radius: 50px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 8px 24px rgba(240, 147, 251, 0.4);
        transition: all 0.3s ease;
        pointer-events: auto;
      }
      .mode-toggle:active {
        transform: translateX(-50%) scale(0.95);
      }
      .info-button {
        position: fixed;
        bottom: 60px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 50;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 16px 40px;
        border-radius: 50px;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
        transition: all 0.3s ease;
        pointer-events: auto;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .info-button:active {
        transform: translateX(-50%) scale(0.95);
      }
      .info-button svg {
        width: 24px;
        height: 24px;
      }
      .controls-hint {
        position: fixed;
        top: 80px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 50;
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        padding: 12px 20px;
        border-radius: 12px;
        font-size: 12px;
        text-align: center;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s;
      }
      .controls-hint.show {
        opacity: 1;
      }
    </style>
  </head>
  <body>
    <div class="ui">
      <div class="card">
        <strong>Oldest Human Skull</strong><br />
        <span id="modeText">Anchored Mode</span>
      </div>
      <div class="card" id="status">Status: <strong>Scanning</strong></div>
    </div>
    <div class="center-hint" id="hint">Point camera at target image...</div>
    <div class="controls-hint" id="controlsHint">
      Pinch to scale • Drag to rotate
    </div>
    
    <button class="mode-toggle" id="modeToggle" style="display: none;">
      Switch to Free View
    </button>
    
    <button class="info-button" onclick="window.location.href='skull-info.html'">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      Learn More
    </button>
    
    <a-scene
      mindar-image="imageTargetSrc: assets/demo.mind; autoStart: true; uiLoading: no; uiError: no; uiScanning: no;"
      color-space="sRGB"
      renderer="colorManagement: true; physicallyCorrectLights: true; alpha: true;"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
      embedded
      gesture-detector
    >
      
      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
      
      <!-- Anchored Mode - Target based -->
      <a-entity mindar-image-target="targetIndex: 0" id="target">
        <a-entity id="skullAnchor">
          <a-gltf-model
            id="skullModel"
            src="assets/skull.glb"
            position="0 0 0"
            scale="0.5 0.5 0.5"
            rotation="0 0 0"
            animation="property: rotation; to: 0 360 0; loop: true; dur: 8000; easing: linear"
          ></a-gltf-model>
          
          <!-- Lighting for the skull -->
          <a-light type="point" intensity="1" position="0 2 1" color="#fff"></a-light>
          <a-light type="ambient" intensity="0.5" color="#fff"></a-light>
        </a-entity>
      </a-entity>
      
      <!-- Free View Mode - Screen center with gestures -->
      <a-entity id="freeSkull" visible="false" position="0 0 -1.5">
        <a-gltf-model
          src="assets/skull.glb"
          position="0 0 0"
          scale="0.3 0.3 0.3"
          rotation="0 0 0"
          class="interactive"
          gesture-handler="minScale: 0.1; maxScale: 1.5"
        ></a-gltf-model>
        
        <a-light type="point" intensity="1.5" position="0 1 1" color="#fff"></a-light>
        <a-light type="point" intensity="0.8" position="0 -1 1" color="#fff"></a-light>
        <a-light type="ambient" intensity="0.6" color="#fff"></a-light>
      </a-entity>
    </a-scene>
    
    <script>
      // Gesture handler component for pinch and drag
      AFRAME.registerComponent('gesture-handler', {
        schema: {
          minScale: { default: 0.1 },
          maxScale: { default: 2 }
        },
        init: function() {
          this.handleScale = this.handleScale.bind(this);
          this.handleRotation = this.handleRotation.bind(this);
          
          this.el.sceneEl.addEventListener('onefingermove', this.handleRotation);
          this.el.sceneEl.addEventListener('twofingermove', this.handleScale);
          
          this.initialScale = this.el.object3D.scale.clone();
          this.scaleFactor = 1;
        },
        handleRotation: function(event) {
          if (!this.el.parentEl.getAttribute('visible')) return;
          
          const rotation = this.el.object3D.rotation;
          rotation.y += event.detail.positionChange.x * 2;
          rotation.x += event.detail.positionChange.y * 2;
        },
        handleScale: function(event) {
          if (!this.el.parentEl.getAttribute('visible')) return;
          
          this.scaleFactor *= 1 + event.detail.spreadChange / 500;
          this.scaleFactor = Math.min(Math.max(this.scaleFactor, this.data.minScale), this.data.maxScale);
          
          this.el.object3D.scale.set(
            this.scaleFactor * this.initialScale.x,
            this.scaleFactor * this.initialScale.y,
            this.scaleFactor * this.initialScale.z
          );
        }
      });
      
      AFRAME.registerComponent('gesture-detector', {
        schema: {
          element: { default: '' }
        },
        init: function() {
          this.handleTouchStart = this.handleTouchStart.bind(this);
          this.handleTouchMove = this.handleTouchMove.bind(this);
          this.handleTouchEnd = this.handleTouchEnd.bind(this);
          
          this.touchStarted = false;
          this.fingers = 0;
          
          this.el.addEventListener('touchstart', this.handleTouchStart);
          this.el.addEventListener('touchmove', this.handleTouchMove);
          this.el.addEventListener('touchend', this.handleTouchEnd);
        },
        handleTouchStart: function(event) {
          this.touchStarted = true;
          this.fingers = event.touches.length;
          
          if (this.fingers === 1) {
            this.startX = event.touches[0].clientX;
            this.startY = event.touches[0].clientY;
          } else if (this.fingers === 2) {
            const dx = event.touches[0].clientX - event.touches[1].clientX;
            const dy = event.touches[0].clientY - event.touches[1].clientY;
            this.initialSpread = Math.sqrt(dx * dx + dy * dy);
          }
        },
        handleTouchMove: function(event) {
          if (!this.touchStarted) return;
          
          if (this.fingers === 1) {
            const deltaX = event.touches[0].clientX - this.startX;
            const deltaY = event.touches[0].clientY - this.startY;
            
            this.el.emit('onefingermove', {
              positionChange: {
                x: deltaX / window.innerWidth,
                y: deltaY / window.innerHeight
              }
            });
            
            this.startX = event.touches[0].clientX;
            this.startY = event.touches[0].clientY;
          } else if (this.fingers === 2) {
            const dx = event.touches[0].clientX - event.touches[1].clientX;
            const dy = event.touches[0].clientY - event.touches[1].clientY;
            const spread = Math.sqrt(dx * dx + dy * dy);
            
            this.el.emit('twofingermove', {
              spreadChange: spread - this.initialSpread
            });
            
            this.initialSpread = spread;
          }
        },
        handleTouchEnd: function() {
          this.touchStarted = false;
        }
      });
      
      const target = document.querySelector("#target");
      const statusEl = document.querySelector("#status");
      const hintEl = document.querySelector("#hint");
      const modeToggle = document.querySelector("#modeToggle");
      const modeText = document.querySelector("#modeText");
      const controlsHint = document.querySelector("#controlsHint");
      const skullAnchor = document.querySelector("#skullAnchor");
      const freeSkull = document.querySelector("#freeSkull");
      
      let isAnchoredMode = true;
      let targetDetected = false;
      
      // Target found
      target.addEventListener("targetFound", () => {
        targetDetected = true;
        statusEl.innerHTML = "Status: <strong style='color: #4ade80'>Detected ✓</strong>";
        hintEl.innerText = "Skull anchored to target!";
        modeToggle.style.display = "block";
        console.log("Target found!");
      });
      
      // Target lost
      target.addEventListener("targetLost", () => {
        targetDetected = false;
        if (isAnchoredMode) {
          statusEl.innerHTML = "Status: <strong style='color: #fb923c'>Lost</strong>";
          hintEl.innerText = "Point camera at target image";
          modeToggle.style.display = "none";
        }
        console.log("Target lost");
      });
      
      // Mode toggle
      modeToggle.addEventListener("click", () => {
        isAnchoredMode = !isAnchoredMode;
        
        if (isAnchoredMode) {
          // Switch to anchored mode
          skullAnchor.setAttribute('visible', 'true');
          freeSkull.setAttribute('visible', 'false');
          modeToggle.textContent = "Switch to Free View";
          modeText.textContent = "Anchored Mode";
          hintEl.innerText = "Skull anchored to target!";
          controlsHint.classList.remove('show');
          
          if (!targetDetected) {
            modeToggle.style.display = "none";
          }
        } else {
          // Switch to free view mode
          skullAnchor.setAttribute('visible', 'false');
          freeSkull.setAttribute('visible', 'true');
          modeToggle.textContent = "Switch to Anchored";
          modeText.textContent = "Free View Mode";
          hintEl.innerText = "Interact with the skull!";
          controlsHint.classList.add('show');
          
          setTimeout(() => {
            controlsHint.classList.remove('show');
          }, 3000);
        }
      });
    </script>
  </body>
</html>